package repository;

import java.io.EOFException;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Comparator;
import java.util.Date;
import java.util.LinkedList;

import data.Libro;
import data.Movimiento;
import objects.Object_Output_StreamSinHeader;

public class Ops {

	/**
	 * Desarrolla una aplicación Java para gestionar el inventario de una
	 * biblioteca. La aplicación debe permitir al usuario: Pestaña Gestión de
	 * Libros:
	 * 
	 * • Añadir libros: El usuario debe poder introducir los datos de un libro, como
	 * el nombre, descripción, categoría, cantidad de copias actual. Se debe
	 * utilizar una clase Libro para representar los libros, con atributos para
	 * almacenar cada uno de estos datos. La clase debe incluir métodos para acceder
	 * y modificar los atributos de un libro.
	 * 
	 * • Eliminar libros: El usuario debe poder eliminar un libro por su nombre. Se
	 * debe utilizar el método remove() de la lista que almacena los libros para
	 * eliminar el libro correspondiente.
	 * 
	 * • Buscar libros: El usuario debe poder buscar libros por nombre o categoría.
	 * Se debe utilizar la funcionalidad de filtrado de listas para buscar los
	 * libros que coincidan con los criterios del usuario.
	 * 
	 * • Listar libros: El usuario debe poder ver una lista de todos los libros en
	 * el inventario, ordenada por nombre, descripción, categoría o stock. Se debe
	 * utilizar el método sort() de la lista para ordenar los libros según el
	 * criterio elegido por el usuario.
	 * 
	 * • Al cerrar el programa, los libros se guardarán en un fichero como objetos y
	 * serán cargados automáticamente la siguiente vez que se abra el programa.
	 * 
	 * 
	 * • Registrar devolución de libros: El usuario debe poder registrar la
	 * devolución de un determinado libro en el almacén. Se debe registrar la
	 * cantidad de unidades recibidas y la fecha de devolución. Se debe actualizar
	 * el stock del libro correspondiente. Esta información se guardará en un
	 * fichero de log de devoluciones y préstamos.
	 * 
	 * • Registrar préstamo de libros: El usuario debe poder registrar el préstamo
	 * de libros de la biblioteca. Se debe registrar la cantidad de unidades
	 * prestadas y la fecha de préstamo. Se debe actualizar el stock del libro
	 * correspondiente. Esta información se guardará en un fichero de log de
	 * devoluciones y préstamos.
	 * 
	 * • Consultar historial de devoluciones y prestamos: El usuario debe poder
	 * consultar el historial de devoluciones y prestamos de un libro. Se debe
	 * mostrar la fecha, la cantidad el tipo de movimiento (devolución o préstamo)
	 * para cada registro.
	 * 
	 */

	private static LinkedList<Libro> libros = new LinkedList<>();
	private static File librosGuardados = new File(".\\Biblioteca\\Libros\\Libros.txt");
	private static File movimientos = new File(".\\Biblioteca\\Movimientos\\Movimientos.txt");

	public static LinkedList<Libro> getLibros() {
		return libros;
	}

	public static void setLibros(LinkedList<Libro> libros) {
		Ops.libros = libros;
	}

	public static File getMovimientos() {
		return movimientos;
	}

	public static void setMovimientos(File movimientos) {
		Ops.movimientos = movimientos;
	}

	// GESTION DE LIBROS

	// CHECK
	public static void addBook(String nombre, String descripcion, String categoria, int cantidadCopias) {
		/*
		 * Manejo de errores
		 */

		libros.add(new Libro(nombre, descripcion, categoria, cantidadCopias));
	}

	// CHECK
	public static void removeBook(String nombre) {
		/*
		 * Manejo de errores
		 */

		libros.remove(new Libro(nombre, "", "", 0));

	}

	public static Libro searchByName(String nombre) {
		/*
		 * Manejo de errores
		 */

		for (Libro l : libros)
			if (l.getNombre().equals(nombre))
				return l;
		return null;
	}

	public static ArrayList<Libro> searchByCategory(String categoria) {
		/*
		 * Manejo de errores
		 */

		ArrayList<Libro> librosCategoria = new ArrayList<>();

		for (Libro l : libros)
			if (l.getNombre().equals(categoria))
				librosCategoria.add(l);

		return librosCategoria;

	}

	public static void listBooks(String criterio) {
		if (criterio.equals("Nombre")) {
			libros.sort(Comparator.comparing(Libro::getNombre));
		} else if (criterio.equals("Descipcion")) {
			libros.sort(Comparator.comparing(Libro::getDescripcion));
		} else if (criterio.equals("Categoria")) {
			libros.sort(Comparator.comparing(Libro::getCategoria));
		} else if (criterio.equals("Copias")) {
			libros.sort(Comparator.comparing(Libro::getCantidadCopias));
		}

	}

	// CHECK
	public static void saveBooks(LinkedList<Libro> libros) throws FileNotFoundException, IOException {

		/*
		 * Manejo de errores
		 */

		ObjectOutputStream oos = null;
		librosGuardados.delete();
		librosGuardados = new File(".\\Biblioteca\\Libros\\Libros.txt");
		librosGuardados.createNewFile();
		oos = new ObjectOutputStream(new FileOutputStream(librosGuardados));

		for (Libro l : libros)
			oos.writeObject(l);

		oos.close();
	}

	// CHECK
	public static void inputBooks() throws FileNotFoundException, IOException, ClassNotFoundException {

		/*
		 * Manejo de errores
		 */

		if (librosGuardados.exists()) {
			ObjectInputStream ois = new ObjectInputStream(new FileInputStream(librosGuardados));

			boolean finalArchivo = false;
			while (!finalArchivo)
				try {
					libros.add((Libro) ois.readObject());
				} catch (EOFException e) {
					finalArchivo = true;
				}
			ois.close();
		}
	}

	// GESTION DE PRESTAMOS Y DEVOLUCIONES

	// CHECK
	public static void returnOrLoanBook(String nombre, String fechaMov, String tipo, int numCopias)
			throws FileNotFoundException, IOException, ParseException {

		/*
		 * Manejo de errores
		 */

		Libro libro = null;
		for (Libro l : libros)
			if (l.getNombre().equals(nombre))
				libro = l; // Si no encuentra, lanza excepcion
		ObjectOutputStream oos;
		if (!movimientos.exists()) {
			movimientos = new File(".\\Biblioteca\\Movimientos\\Movimientos.txt");
			movimientos.createNewFile();
			oos = new ObjectOutputStream(new FileOutputStream(movimientos));
		} else
			oos = new Object_Output_StreamSinHeader(new FileOutputStream(movimientos, true));

		SimpleDateFormat sdf = new SimpleDateFormat("dd/MM/yy");
		Date fechaMovimiento = sdf.parse(fechaMov);

		Movimiento m = null;
		if (tipo.equals("devolucion")) {
			m = new Movimiento(libro, fechaMovimiento, "devolucion", numCopias);
			libro.setCantidadCopias(libro.getCantidadCopias() + numCopias);
		} else if (tipo.equals("prestamo")) {
			m = new Movimiento(libro, fechaMovimiento, "prestamo", numCopias);
			libro.setCantidadCopias(libro.getCantidadCopias() - numCopias);
			if (libro.getCantidadCopias() < 0) {
				/* Lanza excepcion */
			}

		}
		oos.writeObject(m);

		oos.close();
	}

	public static ArrayList<Movimiento> checkMovesByBook(String nombre)
			throws FileNotFoundException, IOException, ClassNotFoundException {

		ObjectInputStream ois = new ObjectInputStream(new FileInputStream(movimientos));
		ArrayList<Movimiento> movimientosLibro = new ArrayList<>();
		boolean finalArchivo = false;
		while (!finalArchivo)
			try {
				Movimiento m = (Movimiento) ois.readObject();
				if (m.getLibro().getNombre().equals(nombre))
					movimientosLibro.add(m);
			} catch (EOFException e) {
				finalArchivo = true;
			}

		ois.close();
		return movimientosLibro;
	}

	// GENERACION DE INFORMES

	// CHECK
	public static ArrayList<Libro> genInfoBooks() throws FileNotFoundException, IOException, ClassNotFoundException {

		ObjectInputStream ois = new ObjectInputStream(new FileInputStream(librosGuardados));
		ArrayList<Libro> librosInfo = new ArrayList<>();
		boolean finalArchivo = false;
		while (!finalArchivo)
			try {
				Libro m = (Libro) ois.readObject();
				librosInfo.add(m);
			} catch (EOFException e) {
				finalArchivo = true;
			}

		ois.close();
		return librosInfo;
	}

	// CHECK
	public static ArrayList<Movimiento> genInfoMoves()
			throws FileNotFoundException, IOException, ClassNotFoundException {

		ObjectInputStream ois = new ObjectInputStream(new FileInputStream(movimientos));
		ArrayList<Movimiento> movimientosInfo = new ArrayList<>();
		boolean finalArchivo = false;
		while (!finalArchivo)
			try {
				Movimiento m = (Movimiento) ois.readObject();
				movimientosInfo.add(m);
			} catch (EOFException e) {
				finalArchivo = true;
			}

		ois.close();
		return movimientosInfo;
	}

	// MAIN PRUEBAS
	public static void main(String[] args)
			throws FileNotFoundException, IOException, ClassNotFoundException, ParseException {
		try {
			addBook("La promesa", "Una promesa", "Novela", 500);
			addBook("Mis huevos", "Una promesa", "Drama", 50);
			

			saveBooks(libros);
			for (Libro l : genInfoBooks())
				System.out.println(l.toString());
			System.out.println("****************************************");
			returnOrLoanBook("Mis huevos", "1/05/24", "prestamo", 1);
			returnOrLoanBook("La promesa", "18/05/24", "devolucion", 1);
			returnOrLoanBook("Mis huevos", "24/12/18", "devolucion", 5);

			saveBooks(libros);

			for (Libro l : genInfoBooks())
				System.out.println(l.toString());
			System.out.println("****************************************");

			for (Movimiento m : genInfoMoves())
				System.out.println(m.toString());
			System.out.println("****************************************");

			for (Movimiento m : checkMovesByBook("Mis huevos"))
				System.out.println(m.toString());

		} catch (Exception e) {
			librosGuardados.delete();
			movimientos.delete();
		}
	}

}